In this article we discuss how to include CSS and JavaScript in our Rails applications using the **Asset Pipeline**.

### Learning Goals

* Understand why CSS and JavaScript are regarded as static assets
* Include assets using the asset pipeline
* Include multiple files with a single helper method
* Compile alternative languages to CSS and JavaScript

### Static Assets

The web relies on several core technologies to render pages. We typically start with HTML to define and structure the content of the page, then layer on CSS to adjust the appearance and JavaScript to make it more interactive. The HTML is often generated dynamically within the view layer of a Rails application. This enables us to build pages on-the-fly with information submitted from the user, retrieved from the database, or from any other number of sources.

On the other hand, our CSS and JavaScript define a set rules for how to display and interact with the page. Because these rules don't change as we add new information, we don't need to generate our CSS and JavaScript files dynamically. We can define them once and use them for all pages on our site. We'll refer to our CSS and JavaScript files as our **static assets**.

### Linking External Assets

There are a few ways to include CSS and JavaScript on a web page. One method is to store them in external files that are then referenced within an application using the `<link>` or `<script>` tags:

```html
<!DOCTYPE html>
<html>
  <head>
    <title>Example Web Page</title>
    <link rel="stylesheet" href="/styles.css">
  </head>

  <body>
    <!-- page content goes here -->

    <script src="/application.js"></script>
  </body>
</html>
```

When a browser loads this HTML, it scans for these tags and will send additional HTTP requests to fetch the external stylesheets and JavaScript source files.

Although this extra request has a bit of overhead, one benefit from using external stylesheets and source files is that the browser can **cache** them and reuse them between pages. For example, if a browser downloads the stylesheet at `/styles.css`, it will save that file locally for a period of time. Next time the browser sees `<link rel="stylesheet" href="/styles.css">` on a page from the same web site, it will use the file it already downloaded rather than retrieving it again (as long as it hasn't been modified). This saves bandwidth and results in faster loading times for our web pages.

### Asset Pipeline

When we create a new Rails application, we end up with a layout file in `app/views/layouts/application.html.erb` that contains the following snippet:

```html
<head>
  <title>The Unofficial Troll 2 Fan Site</title>
  <%= stylesheet_link_tag "application", media: "all" %>
  <%= javascript_include_tag "application" %>
  <%= csrf_meta_tags %>
</head>
```

Rather than including the `<link>` and `<script>` tags explicitly, Rails uses the `stylesheet_link_tag` and `javascript_include_tag` helpers instead. The first argument of each helper supplies the name of the stylesheet or source file found in `app/assets/stylesheets` or `app/assets/javascripts`. For example, the following helper method:

```ruby
stylesheet_link_tag "application", media: "all"
```

Will generate the following HTML:

```html
<link rel="stylesheet" media="all" href="/assets/application-5...d.css?body=1" />
```

The link to `href="/assets/application-5...d.css"` actually references the file found in `app/assets/stylesheets/application.css`. If we inspect this file we see one large comment at the top:

```css
/*
 * This is a manifest file that'll be compiled into application.css, which will include all the files
 * listed below.
 *
 * Any CSS and SCSS file within this directory, lib/assets/stylesheets, vendor/assets/stylesheets,
 * or any plugin's vendor/assets/stylesheets directory can be referenced here using a relative path.
 *
 * You're free to add application-wide styles to this file and they'll appear at the bottom of the
 * compiled file so the styles you add here take precedence over styles defined in any styles
 * defined in the other CSS/SCSS files in this directory. It is generally better to create a new
 * file per style scope.
 *
 *= require_tree .
 *= require_self
 */
```

We could add CSS rules to this file and they'll be included with the link generated by `stylesheet_include_tag "application"`.

### Requiring Libraries

The same process is used for JavaScript. The helper method:

```ruby
javascript_include_tag "application"
```

Will generate the following HTML:

```html
<script src="/assets/jquery-8...0.js?body=1"></script>
<script src="/assets/jquery_ujs-e...4.js?body=1"></script>
<script src="/assets/application-8...9.js?body=1"></script>
```

This is similar to the stylesheets, but where did `jquery` and `jquery_ujs` come from? Let's look at `app/assets/javascripts/application.js`:

```javascript
// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts,
// or any plugin's vendor/assets/javascripts directory can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// compiled file.
//
// Read Sprockets README (https://github.com/sstephenson/sprockets#sprockets-directives) for details
// about supported directives.
//
//= require jquery
//= require jquery_ujs
//= require_tree .
```

This file only contains the above comment, but look at the last three lines:

```javascript
//= require jquery
//= require jquery_ujs
//= require_tree .
```

Although the `//` signifies a comment in JavaScript, Rails utilizes a library called [Sprockets](https://github.com/sstephenson/sprockets) to compile and package our assets. Sprockets will look for comments starting with `//=` and use them to *include* additional JavaScript files. Here we're including two additional JavaScript libraries: jQuery and jQuery UJS (Unobtrusive JavaScript).

Where did these additional files come from? If we check the Gemfile we'll notice a reference to the `jquery-rails` gem:

```ruby
# Use jquery as the JavaScript library
gem 'jquery-rails'
```

This library packages up jQuery and makes it available in be included in our assets.

### Multiple Files

Writing all of our CSS in `app/assets/stylesheets/application.css` and JavaScript in `app/assets/javascripts/application.js` can become unwieldy as the files grow larger. An alternative is to break these up into smaller files that group styles and code conceptually. We're free to organize the files as we wish and can rely on Sprockets to include them all using the `stylesheet_link_tag` and `javascript_include_tag` helpers.

Consider adding a new stylesheet named `sample.css`:

```
app/assets/stylesheets
├── application.css
└── sample.css
```

When we render the page we'll see the new sample file is automatically included for us:

```html
<link rel="stylesheet" media="all" href="/assets/sample-6...7.css?body=1" />
<link rel="stylesheet" media="all" href="/assets/application-5...d.css?body=1" />
```

Nowhere did we explicitly include this new `sample.css` file but Rails knew to add the extra `<link>` tag when it rendered the page. If we look back at the `application.css` file we might notice the following statements at the end of the comment:

```css
/*
 *= require_tree .
 *= require_self
 */
```

The `*= require_tree .` statement is instructing Sprockets to include all files in the current directory and any sub-directories. Since `sample.css` is in the current directory, this gets picked up and is included automatically in our HTML. The `*= require_self` statement will include any CSS statements that are defined within the `application.css` file last (meaning that `sample.css` will be linked before `application.css`).

### Alternative Languages

Modern web browsers are equipped to render HTML with CSS and run any JavaScript code. It is up to the web developer to prepare this content accordingly and send it back to the browser in an HTTP response body.

Even though we are limited to HTML, CSS, and JavaScript when presenting our pages to the user, we can use whatever technologies are available to us to generate this content. For example, rather than writing HTML pages by hand, we rely on Ruby and ERB (or any other templating language) to generate the HTML on-the-fly before sending it back to the browser. The end user is unaware of how we generated the page since the only part they see is the final product.

Similarly, we can use other languages as alternatives to JavaScript and CSS as long as we have a way to generate those languages from our source. [CoffeeScript](http://coffeescript.org/) and [Sass](http://sass-lang.com/) are two popular alternatives to JavaScript and CSS that offer us additional benefits during development time but still compile down to the original language when viewed by the user.

If we look at the `Gemfile` we'll notice that both technologies are supported by default:

```ruby
# Use SCSS for stylesheets
gem 'sass-rails', '~> 5.0'

# Use CoffeeScript for .coffee assets and views
gem 'coffee-rails', '~> 4.1.0'
```

If we want to include a CoffeeScript or Sass file in our application, change the file extension to either `.coffee` or `.scss` in the respective folder:

```no-highlight
app/assets
├── javascripts
│   ├── application.js
│   └── test.coffee
└── stylesheets
    ├── application.css
    └── test.scss
```

When we reload the page we'll see that Rails compiled both files to CSS and JavaScript and included them in the header:

```html
<link rel="stylesheet" media="all" href="/assets/test-6...7.css?body=1" />
<script src="/assets/test-f...d.js?body=1"></script>
```

### Resources

* [Rails Guide to the Asset Pipeline](http://guides.rubyonrails.org/asset_pipeline.html)
